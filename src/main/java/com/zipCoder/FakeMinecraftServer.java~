package com.zipCoder;

import java.io.*;
import java.net.*;
import java.nio.charset.StandardCharsets;

public class FakeMinecraftServer {

    static Config config = new Config();

    public static void main(String[] args) throws IOException {
        Config config = new Config();
        for (Server server : config.servers) {
            (new Thread(()-> runServer(server))).start();
        }
    }

    public static void runServer(Server server) {
        try {
            ServerSocket serverSocket = new ServerSocket(server.port);
            System.out.println("Fake server running on port " + server.port);
            while (true) {
                try (Socket socket = serverSocket.accept()) {
                    System.out.println("Connection from " + socket.getInetAddress());

                    DataInputStream in = new DataInputStream(socket.getInputStream());
                    DataOutputStream out = new DataOutputStream(socket.getOutputStream());

                    try {
                        // === Handshake Packet ===
                        int packetLength = readVarInt(in);
                        int packetId = readVarInt(in);  // Should be 0 (Handshake)
                        int protocolVersion = readVarInt(in);  // Protocol version
                        String serverAddress = readString(in);
                        int serverPort = in.readUnsignedShort();
                        int nextState = readVarInt(in);  // 1 = status, 2 = login

                        if (nextState == 2) {
                            // === Login Start Packet ===
                            packetLength = readVarInt(in);
                            packetId = readVarInt(in);  // Should be 0 (Login Start)
                            String username = readString(in);
                            System.out.println("User: " + username);

                            // === Send Login Disconnect ===
                            try {
                                String json = "{\"text\":\"" + config.rejectMessage + "\"}";
                                ByteArrayOutputStream buffer = new ByteArrayOutputStream();
                                DataOutputStream packet = new DataOutputStream(buffer);
                                packet.writeByte(0x00); // Login Disconnect packet ID
                                writeString(packet, json);
                                sendPacket(out, buffer.toByteArray());
                            } catch (Exception e) {
                                e.printStackTrace();
                            }

                            // === Send discord webhook ===
                            try {
                                DiscordWebhook webhook = new DiscordWebhook(config.discordWebhook);
                                webhook.setUsername("Watcher App");
                                webhook.setContent("Player **" + username + "** wants to join server **" + server.name + "**");
                                webhook.execute();
                            } catch (Exception e) {
                                e.printStackTrace();
                            }
                        }

                        socket.close();
                    } catch (Exception e) {
                        e.printStackTrace();
                        socket.close();
                    }
                }
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    // Helper methods
    static void sendPacket(DataOutputStream out, byte[] data) throws IOException {
        writeVarInt(out, data.length);
        out.write(data);
    }

    static int readVarInt(DataInputStream in) throws IOException {
        int numRead = 0, result = 0;
        byte read;
        do {
            read = in.readByte();
            int value = (read & 0b01111111);
            result |= (value << (7 * numRead));
            numRead++;
            if (numRead > 5) throw new IOException("VarInt too big");
        } while ((read & 0b10000000) != 0);
        return result;
    }

    static void writeVarInt(DataOutputStream out, int value) throws IOException {
        do {
            byte temp = (byte) (value & 0b01111111);
            value >>>= 7;
            if (value != 0) temp |= 0b10000000;
            out.writeByte(temp);
        } while (value != 0);
    }

    static String readString(DataInputStream in) throws IOException {
        int length = readVarInt(in);
        byte[] bytes = new byte[length];
        in.readFully(bytes);
        return new String(bytes, StandardCharsets.UTF_8);
    }

    static void writeString(DataOutputStream out, String str) throws IOException {
        byte[] bytes = str.getBytes(StandardCharsets.UTF_8);
        writeVarInt(out, bytes.length);
        out.write(bytes);
    }
}
